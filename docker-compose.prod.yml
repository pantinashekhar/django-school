services:
  db:
    image: mysql:8.0
    container_name: django-school-mysql
    environment:
      MYSQL_ROOT_PASSWORD: Krishna123
      MYSQL_DATABASE: school_db
    volumes:
      - db_volume:/var/lib/mysql
    ports:
      - "3306:3306"
    healthcheck:
      test: ["CMD-SHELL", "mysqladmin ping -h localhost -uroot -p$MYSQL_ROOT_PASSWORD"]
      interval: 10s
      timeout: 5s
      retries: 10
    restart: unless-stopped
    networks:
      - web-network

  web:
    build: .
    container_name: django-school-prod
    depends_on:
      db:
        condition: service_healthy
    working_dir: /app
    command: >
      sh -c "
        python school/manage.py migrate --noinput &&
        python school/manage.py collectstatic --noinput &&
        gunicorn school.school.wsgi:application
        --bind 0.0.0.0:8000
        --workers 4
        --timeout 120
      "
    ports:
      - "8000:8000"
    environment:
      DJANGO_SETTINGS_MODULE: school.settings
      DEBUG: "False"
      SECRET_KEY: django-insecure-*&if_30_o1ibo%%i0o!^a6gtz0#1g@-#&eknb8v+lt&ei3oc0j
      ALLOWED_HOSTS: localhost,127.0.0.1,web,django-school-webapp.onrender.com
      DB_ENGINE: mysql
      DB_NAME: school_db
      DB_USER: root
      DB_PASSWORD: Krishna123
      DB_HOST: db
      DB_PORT: "3306"
      SECURE_SSL_REDIRECT: "False"
      SESSION_COOKIE_SECURE: "False"
      CSRF_COOKIE_SECURE: "False"
      DJANGO_LOG_LEVEL: INFO
    volumes:
      - static_volume:/app/staticfiles
      - media_volume:/app/media
      - logs_volume:/app/logs
    restart: always
    networks:
      - web-network

volumes:
  db_volume:
  static_volume:
  media_volume:
  logs_volume:

networks:
  web-network:
    driver: bridge
